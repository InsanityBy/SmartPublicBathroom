---
title: "设计草稿"
author: 马博阳
date: 2022.4.5
output: pdf
---
##修改历史
|版本|日期|说明|作者|
|:-:|:-:|:-|:-:|
|V1.0|2022年4月5日|创建设计草稿|马博阳|
#终端
##具体功能
1. 显示屏可以显示的内容（SPI或8位并行）
   本机编号：xxx
   当前时间：xxxx年xx月xx日xx:xx:xx
   剩余金额：xx元
   水温：xx℃
   用户名：xxx
   本次消费：xxx元 用水：xx升 用时：xx分钟
   状态信息：设备故障、 无热水供应、已预约、5分钟后停止供水、5分钟后预约时间结束、遗落物品、请尽快开始洗澡、洗澡结束请尽快离开
2. 扬声器播放内容（扬声器+语音芯片）
   物品遗落请及时取走
   5分钟后停止供水
   5分钟后预约时间结束
   请您尽快开始洗澡
   洗澡结束请尽快离开
3. 读卡器（模块）
   刷卡后识别用户信息，显示用户名和余额
   挂失卡显示：此卡已挂失
4. 按钮（2个）
   一个用来报修
   一个用来求助
5. 温度模块
   热敏电阻+电桥+差分放大+滤波+ADC
   贴在管壁或者从流量计塞进去
6. 人体/物品检测（红外反射式或超声波）
   正对人体一对收发管反射式
   物品篮一对收发管，对管
7. 流量计（模块）
   需要对脉冲进行计数
8. 电磁阀
   通过继电器控制，继电器通过GPIO和MOS管驱动
##设计
###电源
输入为正负12V直流，稳压产生正负12V，降压稳压产生正3.3V
###人机接口
- 显示屏
   0.91寸，单色LCD，裸屏焊接在板上或模块焊接在板上
   - 3.3V供电
   - SPI接口，MCU直接控制
   - 需要编写的程序：LCD.h LCD.c LCD_Data.c，为主程序提供可以直接调用的函数
   - 需要设计的电路：屏幕的插座或接口
- 扬声器
   录音文件转换为十六进制数据，存储在数组中，通过DAC输出，低通滤波，经功放芯片驱动扬声器，如果数据量大，需要加外置Flash
   - 3.3V供电
   - DAC使用MCU自带
   - 低通滤波使用无源RC网络
   - 功放芯片LM4861
   - 需要编写的程序：Speaker.h Speaker.c Speaker_Data.c，为主程序提供可以直接调用的函数
   - 需要设计的电路：驱动电路
- 按钮
   2个微动开关+按键帽
   - 需要编写的程序：Switch.c Switch.h，实现按键消抖，产生中断，中断中启动相应的功能
   - 需要设计的电路：按键电路
- 读卡器
   RC522，可读写复旦卡，读卡和取卡产生中断，读取卡片信息，卡片本身只存储用户识别信息，其余信息均在服务器
   - 3.3V供电
   - SPI接口
   - 需要编写的程序：NFC.h NFC.c，为主程序提供查询函数，以及中断
   - 需要设计的电路：接口或插座
###信号输入
- 温度传感器
   使用热敏电阻，电桥测量，差分放大，滤波，ADC
   - 差分放大和滤波使用运放，运放12V供电
   - 热敏电阻选用PT100，与现有集成的温度传感器相比，响应及时，尤其是温度下降的响应
   - 需要编写的程序：TemperatureSensor.h TemperatureSensor.c
   - **接口**：为主程序提供查询函数，函数返回值为转换后的温度，float型
   - 需要设计的电路：信号处理电路
- 流量计
   中华人民共和国国家标准《建筑给水排水设计规范》GB50015-2003规定，淋浴器额定流量是9升/分钟，压力不低于0.05~0.5Mpa。按流量计公式，大致需要每秒计数70个脉冲，考虑到极限情况，每秒计数100个脉冲，按使用时间2h计算，最大计数720000，需要至少20位计数器，如果另设置变量，可减少到16位，使用流量计模块，输出信号为脉冲值，脉冲需要电平转换至3.3V
   - 12V供电
   - 需要编写的程序：FlowMeter.h FlowMeter.c
   - **接口**：提供控制函数和查询函数，控制函数实现清零、开始、暂停、停止，查询函数返回当前用水量，返回值float型
   - 需要设计的电路：供电和信号转换电路
- 红外传感器
   使用一对红外收发管，检测人体的使用反射方式，检测物品篮使用对射模式，发射管发射940nm红外线，人体及浴室内环境红外辐射的波长约为9000nm ~ 10000nm，对此影响较小。接收管接收400nm ~ 11000nm，940nm最敏感，较为合适。
   - 3.3V供电
   - 接收管在接收到红外线后，会产生压降，可以通过ADC采样
   - 需要编写的程序：InfraredSensor.h InfraredSensor.c，提供状态查询函数和状态改变中断
   - **接口**：查询函数，返回值1bit，有人/物品和没有分别对应0和1
   - 需要设计的电路：信号处理电路
###信号输出
- 电磁阀
   - 12V供电
   - 三极管驱动12V继电器
   - 继电器控制12V电磁阀
   - 需要编写的程序：主程序中使用1个GPIO控制
   - 需要设计的电路：驱动电路
###通信模块
- ZigBee：其传输速率范围为: 10kb/s~250kb/s
   - 使用模块自带的驱动程序进行修改，Communicate_ZigBee.h Communicate_ZigeBee.c
   - **接口**：
   - 数据传输流程：
      - 在刷卡后立即进行一次传输，上报用户信息
      - 在取卡后立即进行一次传输，清除用户信息
      - 按下求助或报警立即进行一次传输
      - 使用时每100ms一次传输
      - 空闲时仅接收数据或状态改变时发送数据
   - 定义数据帧格式
      - 1字节数据类型：S，终端发送给主机；H，主机发送给终端，E，紧急通信
      - 1字节设备编号：终端发送时为终端的编号，主机发送时为目标终端号（全0为广播）
      - 4字节用户编号：即NFC卡号
      - 4字节当前时间：单片机RTC，用于时间同步
      - 4字节当前水温
      - 4字节当前流量
      - 4字节当前余额
      - 10位状态信息：设备报修，设备已预约，设备正在使用，使用结束结算，有物品遗落，求助
      - 1位结束标志符：$
   - 示例
      **终端向主机发送信息**
      |8|8|32|32|32|32|32|10|1|
      |:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
      |S|编号|用户号|当前时间|当前水温|当前流量|余额|状态信息|$|
      **主机向终端发送信息**（余额仅在第一次和最后一次提供）
      |8|8|32|32|32|32|32|10|1|
      |:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
      |H|编号|用户号|当前时间|-|-|余额|状态信息|$|
      **终端发送紧急信息**
      |8|8|32|32|32|32|32|10|1|
      |:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
      |E|编号|用户号|-|-|-|-|状态信息|$|
   - **状态信息列表**
      - 终端发送的状态信息
  
      |9|8|7|6|5|4|3|2|1|0|
      |:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
      |是否停供水|是否故障|是否预约|是否正在使用|是否遗落物品|是否第一次刷卡|是否取卡|是否求助|是否报修|是否设置|

      - 主机发送时，最低位为1表示设置为该状态，最低位为0忽略此状态信息
#主机
##具体功能
1. 接收终端数据，并通过WiFi传输至云端，接收云端数据传输至终端
2. 显示屏可以显示的内容：
   浴室温度
   浴室湿度
   换气扇状态
   照明状态
   设备状态：空闲x台，x台已预约，x台正在使用，x台故障
3. 扬声器播放提示音
   开启/关闭通风和照明时，提示音
   快到供水时间，提示音
4. 温度模块
   热敏电阻+电桥+差分放大+滤波+ADC
5. 湿度模块
   [Reference](http://www.elecfans.com/yuanqijian/dianzuqi/201911261122315.html)
6. 光照模块
   光敏二极管/光敏三极管/光敏电阻+放大+滤波+ADC
7. 风扇和灯光
   继电器控制
##设计
###电源
输入为正负12V直流，稳压产生正负12V，降压稳压产生正3.3V
###人机接口
- 显示屏
   0.91寸，单色LCD，裸屏焊接在板上或模块焊接在板上
   - 3.3V供电
   - SPI接口，MCU直接控制
   - 需要编写的程序：LCD.h LCD.c LCD_Data.c，为主程序提供可以直接调用的函数
   - 需要设计的电路：屏幕的插座或接口
- 扬声器
   录音文件转换为十六进制数据，存储在数组中，通过DAC输出，低通滤波，经功放芯片驱动扬声器，如果数据量大，需要加外置Flash
   - 3.3V供电
   - DAC使用MCU自带
   - 低通滤波使用无源RC网络
   - 功放芯片LM4861
   - 需要编写的程序：Speaker.h Speaker.c Speaker_Data.c，为主程序提供可以直接调用的函数
   - 需要设计的电路：驱动电路
- 按钮
   2个微动开关+按键帽
   - 需要编写的程序：Switch.c Switch.h，实现按键消抖，产生中断，中断中启动相应的功能
   - 需要设计的电路：按键电路
###信号输入
- 温度传感器
   使用热敏电阻，电桥测量，差分放大，滤波，ADC
   - 差分放大和滤波使用运放，运放12V供电
   - 热敏电阻选用PT100，与现有集成的温度传感器相比，响应及时，尤其是温度下降的响应
   - 需要编写的程序：TemperatureSensor.h TemperatureSensor.c
   - **接口**：为主程序提供查询函数，函数返回值为转换后的温度，float型
   - 需要设计的电路：信号处理电路
- 湿度传感器
   - 使用湿敏电阻，RC阻容充放电法，按数据手册
   - 需要编写的程序：HumiditySensor.h HumiditySensor.c
   - **接口**：为主程序提供查询函数，函数返回值为转换后的湿度，float型
   - 需要设计的电路：信号处理电路
- 光照传感器
   光敏三极管更灵敏，电流更大，IV转换、滤波、放大，ADC采样
   - 需要编写的程序：LightSensor.h LightSensor.c
   - **接口**：为主程序提供查询函数，函数返回值为转换后的光照值，float型
   - 需要设计的电路：信号处理电路
###信号输出
- 
   - 12V供电
   - 三极管驱动12V继电器
   - 继电器控制通风或照明
   - 需要编写的程序：主程序中使用2个GPIO控制
   - 需要设计的电路：驱动电路
###通信模块
- ZigBee：其传输速率范围为: 10kb/s~250kb/s
   - 使用模块自带的驱动程序进行修改，Communicate_ZigBee.h Communicate_ZigeBee.c
   - 通信协议与终端相对应
- WiFi
   - 使用模块自带的驱动程序进行修改，Communicate_WiFi.h Communicate_WiFi.c

   - **接口**：
   - 数据传输流程：
      - 每100ms一次传输
      - 紧急信息立即传输
   - 定义数据帧格式
      - 在收到终端发来的数据帧前后附加内容
      - 1字节数据类型：S，终端发送给云端；C，云端发送给终端；E，紧急通信
      - 1字节主机编号：主机发送时为主机的编号，云端发送时为目标主机号（全0为广播）
      - 4字节当前时间
      - 4字节浴室温度
      - 4字节浴室湿度
      - 4字节浴室光照
      - 6位浴室状态
      - 1字节需要发送的终端数据个数N，但最多支持32个设备
      - N * 185bits所有终端数据合并
      - 1位结束标志符：@
   - 示例
      **主机向云端发送信息**
      |8|8|32|32|32|32|6|8|N*185|1|
      |:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
      |S|编号|当前时间|温度|湿度|光照|状态信息|终端数据个数|终端数据|@|
      **云端向主机发送信息**
      |8|8|32|32|32|32|6|8|N*185|1|
      |:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
      |C|编号|当前时间|温度|湿度|光照|状态信息|终端数据个数|终端数据|@|
      **主机送紧急信息**
      |8|8|32|32|32|32|6|8|N*185|1|
      |:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
      |E|编号|-|-|-|-|状态信息|终端数据个数|终端数据|@|
   - **状态信息列表**
      - 主机发送的状态信息
  
      |5|4|3|2|1|0|
      |:-:|:-:|:-:|:-:|:-:|:-:|
      |是否通风|是否照明|是否停供水|是否报修|是否求助|是否设置|

      - 云端发送时，最低位为1表示设置为该状态，最低位为0忽略此状态信息